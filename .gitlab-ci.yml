stages:
  - build
  - test
  - publish

build:
  stage: build
  script:
    - echo "${DRACS_GITLAB_KEY}" > .ssh/git_deploy_key
    - id && ls -l .ssh
    - chmod 400 .ssh/config .ssh/git_deploy_key
    - ./bin/ci/build
  tags:
    - docker-build

jest:
  stage: test
  image: ${CI_REGISTRY_IMAGE}/${CI_PROJECT_NAME}-candidate:${CI_COMMIT_REF_SLUG}
  variables:
    GIT_STRATEGY: none
  script:
    - cd /opt/app-root/src
    - npm run ci_test
    - mv coverage ${CI_PROJECT_DIR}
  coverage: /All files[^|]*\|[^|]*\s+([\d\.]+)/
  artifacts: # these are saved and available to other jobs in this script even when container is removed
    when: always # see docs for possible values
    paths:
      - coverage/ # where to save
  tags:
    - docker

pages:
  tags:
    - docker
  stage: publish
  dependencies:
    - jest
  script: # move all artifacts from previous jobs to public folder
    - mv coverage/ public/
    - echo "PAGES AVAILABLE AT ${CI_PAGES_URL}"
  artifacts:
    when: always
    paths:
      - public
    expire_in: 30 days
