#!/bin/sh
# This must be run within a gitlab ci environment.
raise()
{
  echo "${1}" >&2
}

check_required_environment() {
  if [ -z ${CI_PROJECT_NAME} ]
  then
    raise "MISSING CI_PROJECT_NAME ENVIRONMENT VARIABLE"
    return 1
  fi

  if [ -z ${CI_COMMIT_REF_SLUG} ]
  then
    raise "MISSING CI_COMMIT_REF_SLUG ENVIRONMENT VARIABLE"
    return 1
  fi

  if [ -z ${CI_REGISTRY_IMAGE} ]
  then
    raise "MISSING CI_REGISTRY_IMAGE ENVIRONMENT VARIABLE"
    return 1
  fi

  if [ -z ${CI_ENVIRONMENT_NAME} ]
  then
    raise "MISSING CI_ENVIRONMENT_NAME ENVIRONMENT VARIABLE"
    return 1
  fi

  if [ -z "${CI_COMMIT_SHA}" ]
  then
    raise "MISSING CI_COMMIT_SHA ENVIRONMENT VARIABLE"
    return 1
  fi

  if [ -z ${HELM_TOKEN} ]
  then
    raise "MISSING HELM_TOKEN ENVIRONMENT VARIABLE"
    return 1
  fi

  if [ -z ${HELM_USER} ]
  then
    raise "MISSING HELM_USER ENVIRONMENT VARIABLE"
    return 1
  fi

  if [ -z ${PROJECT_NAMESPACE} ]
  then
    raise "MISSING PROJECT_NAMESPACE ENVIRONMENT VARIABLE"
    return 1
  fi

  if [ -z ${CLUSTER_SERVER} ]
  then
    raise "MISSING CLUSTER_SERVER ENVIRONMENT VARIABLE"
    return 1
  fi

  if [[ -z ${CI_DEPLOY_USER} ]]
  then
    raise "You must set a Deploy Token on your repository"
    return 1
  fi
}

dry_run() {
  [ ${DRY_RUN} ] && raise "skipping for dry run" && return
  return 1
}

cluster_login() {
  raise "authenticating ${HELM_USER} in ${PROJECT_NAMESPACE}"
  dry_run && return

  kubectl config set-cluster dhtskube --server="${CLUSTER_SERVER}" || return 1
  kubectl config set-credentials "${HELM_USER}" --token="${HELM_TOKEN}" || return 1
  kubectl config set-context ${PROJECT_NAMESPACE}-deploy  --cluster=dhtskube --namespace=${PROJECT_NAMESPACE} --user=${HELM_USER} || return 1
  kubectl config use-context ${PROJECT_NAMESPACE}-deploy || return 1
}

init_helm() {
  raise "initializing helm and local tiller"
  dry_run && return

  export TILLER_NAMESPACE=$PROJECT_NAMESPACE
  export HELM_HOST=localhost:44134
  # https://rimusz.net/tillerless-helm/
  # run tiller locally instead of in the cluster
  tiller --storage=secret &
  export TILLER_PID=$!
  sleep 1
  kill -0 ${TILLER_PID}
  if [ $? -gt 0 ]
  then
    raise "tiller not running!"
    return 1
  fi
  helm init --client-only || return 1
  helm repo update || return 1
}

cleanup() {
  kill ${TILLER_PID}
  return
}

lint_template() {
  raise "linting template"
  dry_run && return

  helm lint ${CI_PROJECT_DIR}/helm-chart/${CI_PROJECT_NAME}
}

install_template() {
  raise "installing template"
  dry_run && return

  helm template ${CI_PROJECT_DIR}/helm-chart/${CI_PROJECT_NAME}
}

version() {
  echo "${CI_COMMIT_REF_SLUG}" | sed "s/${CI_ENVIRONMENT_NAME}\-//"
}

deploy_template() {
  raise "deploying template ${CI_ENVIRONMENT_NAME} $(version)"
  dry_run && return

  helm upgrade --force --recreate-pods --debug \
  --set registry.root=${CI_REGISTRY} \
  --set registry.secret.username=${CI_DEPLOY_USER} \
  --set registry.secret.password="${CI_DEPLOY_PASSWORD}" \
  --set image.repository="${CI_REGISTRY_IMAGE}/${CI_PROJECT_NAME}" \
  --set image.tag="${CI_COMMIT_REF_SLUG}" \
  --set version="$(version)" \
  --set url="${ENVIRONMENT_ROUTE_URL}" \
  --set git_commit="${CI_COMMIT_SHA}" \
  --wait \
  --install ${CI_ENVIRONMENT_NAME} ${CI_PROJECT_DIR}/helm-chart/${CI_PROJECT_NAME}
}

get_pods() {
  kubectl get pods -l app=${CI_PROJECT_NAME},environment=${CI_ENVIRONMENT_NAME}
}

watch_deployment() {
  raise "waiting until deployment ${CI_ENVIRONMENT_NAME} $(version) is ready"
  dry_run && return

  kubectl rollout status deployment/${CI_ENVIRONMENT_NAME}-${CI_PROJECT_NAME} -w || return 1
  sleep 5
  get_pods || return 1
  # see what has been deployed
  kubectl describe deployment -l app=${CI_PROJECT_NAME},environment=${CI_ENVIRONMENT_NAME},version=$(version) || return 1
  kubectl describe service -l app=${CI_PROJECT_NAME},environment=${CI_ENVIRONMENT_NAME} || return 1
  kubectl describe route -l app=${CI_PROJECT_NAME},environment=${CI_ENVIRONMENT_NAME} || return 1
}

run_main() {
  check_required_environment || return 1
  cluster_login
  if [ $? -gt 0 ]
  then
    raise "could not login kubectl"
    return 1
  fi

  init_helm
  if [ $? -gt 0 ]
  then
    raise "could not initialize helm"
    return 1
  fi

  lint_template
  if [ $? -gt 0 ]
  then
    raise "linting failed"
    return 1
  fi

  install_template
  if [ $? -gt 0 ]
  then
    raise "could not install template"
    return 1
  fi

  raise "deploying ${CI_REGISTRY_IMAGE}/${CI_PROJECT_NAME}:${CI_COMMIT_REF_SLUG} with helm"
  deploy_template
  if [ $? -gt 0 ]
  then
    raise "could not deploy template"
    return 1
  fi

  watch_deployment
  if [ $? -gt 0 ]
  then
    raise "could not watch deployment"
    return 1
  fi

  cleanup
  echo "ALL Complete!"
  return
}

# DO NOT CHANGE THE NAME OF THIS SCRIPT OR ITS DIRECTORY!
if echo "${0}" | grep 'bin/ci/deploy' > /dev/null 2>&1
then
  run_main
fi
