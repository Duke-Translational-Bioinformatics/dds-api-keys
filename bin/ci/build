#!/bin/bash
# This script builds the nodejs image for the application
# with its devDependencies as ${application}-candidate:${environment}
# so that it can be used for testing in later pipeline stages
# If the target environment is deployable, it also builds the
# ${application}:${environment} production ready image which
# is pruned of all devDependencies, and only includes the express
# application, dist, and node_modules.
raise()
{
  echo "${1}" >&2
}

check_required_environment() {
  required_env="CI_COMMIT_REF_SLUG CI_PROJECT_NAME OAUTH_CLIENT_ID OAUTH_REDIRECT DDS_API_BASE_URL"

  for reqvar in $required_env
  do
    if [ -z ${!reqvar} ]
    then
      raise "missing ENVIRONMENT ${reqvar}!"
      return 1
    fi
  done
}

login() {
  [ ${DO_NOT_PUBLISH} ] && return
  local required_publish_env="CI_REGISTRY CI_REGISTRY_USER CI_REGISTRY_PASSWORD CI_REGISTRY_IMAGE"

  for reqvar in $required_publish_env
  do
    if [ -z ${!reqvar} ]
    then
      raise "missing ENVIRONMENT ${reqvar} REQUIRED TO PUBLISH!
      SET DO_NOT_PUBLISH=1 TO SKIP PUBLISHING TO THE GITLAB REGISTRY
      "
      return 1
    fi
  done
  echo "
  logging into ${CI_REGISTRY}
  "
  echo "${CI_REGISTRY_PASSWORD}" | docker login -u ${CI_REGISTRY_USER} --password-stdin ${CI_REGISTRY}
}

deployable() {
  local target_environment="${1}"
  echo "${target_environment}" | grep '\-deployment' > /dev/null
}

build_candidate() {
  local candidate_image="${1}-candidate:${2}"
  raise "
  Building candidate ${candidate_image}
  "
  docker build --pull -t "${candidate_image}" .
  if [ $? -gt 0 ]
  then
    raise "Problem in the Build"
    return 1
  fi
  publish_image "${candidate_image}"
}

build_deployable() {
  local original_base_image="${1}"
  local candidate_image="${1}-candidate:${2}"
  local deployable_image="${1}:${2}"
  raise "
  Building ${original_base_image} deployable ${deployable_image} FROM ${candidate_image}
  "
  cat Dockerfile.production | sed "s/FROM ${original_base_image}/FROM ${candidate_image}/" | docker build --build-arg OAUTH_CLIENT_ID --build-arg OAUTH_REDIRECT --build-arg DDS_API_BASE_URL -t "${deployable_image}" -
  if [ $? -gt 0 ]
  then
    raise "Problem in the Build"
    return 1
  fi
  publish_image "${deployable_image}"
}

publish_image() {
  [ ${DO_NOT_PUBLISH} ] && return
  local image="${1}"
  local publishable_image="${CI_REGISTRY_IMAGE}/${image}"
  echo "
  tagging ${image} as ${publishable_image}
  "
  docker tag "${image}" "${publishable_image}"
  if [ $? -gt 0 ]
  then
    raise "Problem Tagging"
    return 1
  fi
  echo "
  pushing image to gitlab registry
  "
  docker push "${publishable_image}"
}

run_main() {
  check_required_environment || return 1
  login || return 1

  environment=$(echo "${CI_COMMIT_REF_SLUG}" | sed "s/\-deployment.*//" | sed "s/\_/\-/g")
  application=$(echo "${CI_PROJECT_NAME}" | sed "s/\_/\-/g")

  build_candidate "${application}" "${environment}" || return 1
  if deployable "${CI_COMMIT_REF_SLUG}"
  then
    build_deployable "${application}" "${environment}" || return 1
  fi
  raise "ALL COMPLETE"
}

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]
then
  run_main
  if [ $? -gt 0 ]
  then
    exit 1
  fi
fi
