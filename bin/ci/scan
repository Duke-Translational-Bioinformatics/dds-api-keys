#!/bin/bash
# This script builds the nodejs image for the application
# with its devDependencies as ${application}-candidate:${environment}
# so that it can be used for testing in later pipeline stages
raise()
{
  echo "${1}" >&2
}

check_required_environment() {
  local required_env="CI_COMMIT_REF_SLUG CI_PROJECT_NAME CI_REGISTRY CI_REGISTRY_USER CI_REGISTRY_PASSWORD CI_REGISTRY_IMAGE"

  for reqvar in $required_env
  do
    if [ -z ${!reqvar} ]
    then
      raise "missing ENVIRONMENT ${reqvar}!"
      return 1
    fi
  done
}

login() {
  echo "
  logging into ${CI_REGISTRY}
  "
  dry_run && return
  docker login -u ${CI_REGISTRY_USER} -p ${CI_REGISTRY_PASSWORD} ${CI_REGISTRY}
}

deployable() {
  local target_environment="${1}"
  echo "${target_environment}" | grep 'master\|\-deployment' > /dev/null
}

dry_run() {
  [ ${DRY_RUN} ] && raise "skipping for dry run" && return
  return 1
}

scan_image() {
  local deployable_image="${CI_REGISTRY_IMAGE}/${1}:${2}"

  local claire_image="${CI_REGISTRY}/cats/klar-cmd:latest"
  if [ ${CLAIRE_IMAGE} ]
  then
    claire_image="${CLAIRE_IMAGE}"
  fi

  local claire_address="https://api-route-clair-scanner.cats.dhe.duke.edu:443"
  if [ ${CLAIRE_ADDR} ]
  then
    claire_address="${CLAIRE_ADDR}"
  fi

  raise "Scanning ${deployable_image} with ${claire_address} ${claire_image}"
  raise "using whitelist at ${CI_PROJECT_DIR}/whitelist.yaml"

  if ! dry_run
  then
    docker run --rm \
    -e DOCKER_USER=${CI_REGISTRY_USER} \
    -e DOCKER_PASSWORD="${CI_REGISTRY_PASSWORD}" \
    -e CLAIR_ADDR=${claire_address} \
    -e CLAIR_OUTPUT=High \
    -e CLAIR_THRESHOLD=0 \
    -e WHITELIST_FILE=/data/whitelist.yaml \
    -v ${CI_PROJECT_DIR}/whitelist.yaml:/data/whitelist.yaml \
    ${claire_image} ${deployable_image}
  fi
}

run_main() {
  check_required_environment || exit 1

  if deployable "${CI_COMMIT_REF_SLUG}"
  then
    login || exit 1
    scan_image "${CI_PROJECT_NAME}" "${CI_COMMIT_REF_SLUG}" || return 1
    raise "ALL COMPLETE"
  else
    raise "build_deployment skipping non deployable environment ${CI_COMMIT_REF_SLUG}"
    exit
  fi
}

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]
then
  run_main
  exit $?
fi
